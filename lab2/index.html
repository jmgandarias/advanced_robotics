
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Teaching material for the Advanced Robotics course at The University of MÃ¡laga.">
      
      
      
        <link rel="canonical" href="https://jmgandarias.com/advanced_robotics/lab2/">
      
      
        <link rel="prev" href="../lab1/">
      
      
        <link rel="next" href="../lab3/">
      
      
      <link rel="icon" href="../assets/logo_uma_blanco.svg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.12">
    
    
      
        <title>Lab 2: Manipulator dynamics simulation - Advanced Robotics Course</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.2afb09e1.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        
        <link rel="stylesheet" href="../assets/external/fonts.googleapis.com/css.c3479dc1.css">
        <style>:root{--md-text-font:"Source Sans Pro";--md-code-font:"Source Code Pro"}</style>
      
    
    
      <link rel="stylesheet" href="../css/timeago.css">
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
      <link rel="stylesheet" href="../assets/external/unpkg.com/katex@0/dist/katex.min.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-1SSCKMNFPR"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-1SSCKMNFPR",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-1SSCKMNFPR",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>if("undefined"!=typeof __md_analytics){var consent=__md_get("__consent");consent&&consent.analytics&&__md_analytics()}</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="custom">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#lab-2-manipulator-dynamics-simulation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Advanced Robotics Course" class="md-header__button md-logo" aria-label="Advanced Robotics Course" data-md-component="logo">
      
  <img src="../assets/logo_uma_blanco.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Advanced Robotics Course
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Lab 2: Manipulator dynamics simulation
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="custom"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="custom" data-md-color-accent="custom"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/jmgandarias/advanced_robotics" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    jmgandarias/advanced_robotics
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../about/" class="md-tabs__link">
          
  
  
    
  
  About

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../lab1/" class="md-tabs__link">
          
  
  
    
  
  Lab 1

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="./" class="md-tabs__link">
          
  
  
    
  
  Lab 2

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../lab3/" class="md-tabs__link">
          
  
  
    
  
  Lab 3

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../lab4/" class="md-tabs__link">
          
  
  
    
  
  Lab 4

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../lab5/" class="md-tabs__link">
          
  
  
    
  
  Lab 5

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../lab6/" class="md-tabs__link">
          
  
  
    
  
  Lab 6

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Advanced Robotics Course" class="md-nav__button md-logo" aria-label="Advanced Robotics Course" data-md-component="logo">
      
  <img src="../assets/logo_uma_blanco.png" alt="logo">

    </a>
    Advanced Robotics Course
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/jmgandarias/advanced_robotics" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    jmgandarias/advanced_robotics
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../about/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    About
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_1" id="__nav_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            About
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../about/license/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    License
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../about/acknowledgements/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Acknowledgements
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../about/changelog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Version History
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../lab1/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Lab 1
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Lab 1
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="./" class="md-nav__link md-nav__link--active">
              
  
  
  <span class="md-ellipsis">
    Lab 2
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Lab 2
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../lab3/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Lab 3
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Lab 3
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../lab4/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Lab 4
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Lab 4
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../lab5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Lab 5
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Lab 5
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../lab6/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Lab 6
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Lab 6
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-setup-ros-2" class="md-nav__link">
    <span class="md-ellipsis">
      1. Setup ROS 2
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. Setup ROS 2">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-testing-the-uma-environment" class="md-nav__link">
    <span class="md-ellipsis">
      1.1. Testing the UMA environment
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-install-uma-manipulator-package" class="md-nav__link">
    <span class="md-ellipsis">
      2. Install UMA manipulator package
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Install UMA manipulator package">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-test-the-uma-manipulator-package" class="md-nav__link">
    <span class="md-ellipsis">
      2.1. Test the UMA manipulator package
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-simulate-the-robot-dynamics" class="md-nav__link">
    <span class="md-ellipsis">
      3. Simulate the robot dynamics
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. Simulate the robot dynamics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-clone-the-uma_arm_control-package" class="md-nav__link">
    <span class="md-ellipsis">
      3.1. Clone the uma_arm_control package
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-understanding-the-uma_arm_control-package" class="md-nav__link">
    <span class="md-ellipsis">
      3.2. Understanding the uma_arm_control package
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-understanding-the-uma_arm_dynamicscpp-code" class="md-nav__link">
    <span class="md-ellipsis">
      3.3. Understanding the uma_arm_dynamics.cpp code
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.3. Understanding the uma_arm_dynamics.cpp code">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#331-libraries" class="md-nav__link">
    <span class="md-ellipsis">
      3.3.1. Libraries
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#332-constructor" class="md-nav__link">
    <span class="md-ellipsis">
      3.3.2. Constructor
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#333-timer-callback" class="md-nav__link">
    <span class="md-ellipsis">
      3.3.3. Timer callback
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#334-topic-callbacks" class="md-nav__link">
    <span class="md-ellipsis">
      3.3.4. Topic callbacks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#335-calculate-acceleration" class="md-nav__link">
    <span class="md-ellipsis">
      3.3.5. Calculate acceleration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#336-integrate-position-and-velocity" class="md-nav__link">
    <span class="md-ellipsis">
      3.3.6. Integrate position and velocity
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#337-publish-the-data" class="md-nav__link">
    <span class="md-ellipsis">
      3.3.7. Publish the data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#338-member-variables" class="md-nav__link">
    <span class="md-ellipsis">
      3.3.8. Member variables
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#339-main" class="md-nav__link">
    <span class="md-ellipsis">
      3.3.9. Main
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#34-implementing-the-dynamics-model" class="md-nav__link">
    <span class="md-ellipsis">
      3.4. Implementing the dynamics model
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-launch-the-dynamics-simulator-node" class="md-nav__link">
    <span class="md-ellipsis">
      4. Launch the dynamics simulator node
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Launch the dynamics simulator node">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#terminal-1" class="md-nav__link">
    <span class="md-ellipsis">
      Terminal 1
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#terminal-2" class="md-nav__link">
    <span class="md-ellipsis">
      Terminal 2
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-graphical-representation" class="md-nav__link">
    <span class="md-ellipsis">
      5. Graphical representation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. Graphical representation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#optional-nice-plots-and-vector-images" class="md-nav__link">
    <span class="md-ellipsis">
      Optional - Nice plots and vector images
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/jmgandarias/advanced_robotics/edit/main/docs/lab2/README.md" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  
    
      
    
    <a href="https://github.com/jmgandarias/advanced_robotics/raw/main/docs/lab2/README.md" title="View source of this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"/></svg>
    </a>
  


<div><h1 id="lab-2-manipulator-dynamics-simulation">Lab 2: Manipulator dynamics simulation<a class="headerlink" href="#lab-2-manipulator-dynamics-simulation" title="Permanent link">Â¶</a></h1>
<h2 id="1-setup-ros-2">1. Setup ROS 2<a class="headerlink" href="#1-setup-ros-2" title="Permanent link">Â¶</a></h2>
<p>For this lab session we will use ROS 2 Humble.</p>
<p>You'll need to install the <a href="https://github.com/jmgandarias/uma_environment_tools">uma_environment_tools</a> as it will install ROS2 Humble, and some important packages and libraries that we'll use in the course.
In that repo, you'll find the required steps to install it.</p>
<p>If you already have a native version of Ubuntu 22.04 installed, you can skip steps 1 and 2.</p>
<p>A video of the installation, including the troubleshooting (if you don't find the errors, you don't need to run that part!) is shown below. Note that the video shows the installation with WSL. If you're using a native Ubuntu 22.04, you can skip the first instruction.</p>
<p><div class="video-container"><video style="width:100%" loop muted autoplay alt="type:video"><source src="videos/installation_error.mp4" type="video/mp4"></source></video></div></p>
<h3 id="11-testing-the-uma-environment">1.1. Testing the UMA environment<a class="headerlink" href="#11-testing-the-uma-environment" title="Permanent link">Â¶</a></h3>
<p>Once you have installed the UMA environment, you should see that everything is working correctly.</p>
<p>Try the following;</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>create_catkin_ws
</code></pre></div>
<p>Put the name <code>advanced_robotics_ws</code> to your workspace. </p>
<p>If, after installing it, you go to your catkin workspace folder and when you run this alias</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>cb
</code></pre></div>
<p>you find an error like <code>'ROS colcon build is not installed'</code>, then you'll need to uninstall ros and install the environment again:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>sudo<span class="w"> </span>apt<span class="w"> </span>remove<span class="w"> </span>~nros-humble-*<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>autoremove
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>sudo<span class="w"> </span>rm<span class="w"> </span>/etc/apt/sources.list.d/ros2.list
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>sudo<span class="w"> </span>apt<span class="w"> </span>update
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>sudo<span class="w"> </span>apt<span class="w"> </span>autoremove
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="c1"># Consider upgrading for packages previously shadowed.</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>sudo<span class="w"> </span>apt<span class="w"> </span>upgrade
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="nb">cd</span><span class="w"> </span>~/uma_environment_tools/scripts
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>./install_uma_environment.sh
</code></pre></div>
<p>Then you'll ned to run</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>update_uma_environment
</code></pre></div>
<hr>
<h2 id="2-install-uma-manipulator-package">2. Install UMA manipulator package<a class="headerlink" href="#2-install-uma-manipulator-package" title="Permanent link">Â¶</a></h2>
<p>You'll need to clone the <code>uma_arm_description</code> repository inside </p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>cdw
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="nb">cd</span><span class="w"> </span>src
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/jmgandarias/uma_arm_description.git
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This is a work-in-progress repository. Don't pay attention to the README.md file of that repo.</p>
</div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>You don't have to modify anything in this package. You just need it visualize the manipulator.</p>
</div>
<p>Now, before compiling it, you'll need to install a series of dependencies:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>ros-<span class="si">${</span><span class="nv">ROS_DISTRO</span><span class="si">}</span>-xacro
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>ros-<span class="si">${</span><span class="nv">ROS_DISTRO</span><span class="si">}</span>-gazebo-ros-pkgs
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>sudo<span class="w">  </span>apt<span class="w"> </span>install<span class="w"> </span>ros-<span class="si">${</span><span class="nv">ROS_DISTRO</span><span class="si">}</span>-ros2-control<span class="w"> </span>ros-<span class="si">${</span><span class="nv">ROS_DISTRO</span><span class="si">}</span>-ros2-controllers<span class="w"> </span>ros-<span class="si">${</span><span class="nv">ROS_DISTRO</span><span class="si">}</span>-gazebo-ros2-control
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>ros-<span class="si">${</span><span class="nv">ROS_DISTRO</span><span class="si">}</span>-joint-state-publisher-gui<span class="w"> </span>ros-<span class="si">${</span><span class="nv">ROS_DISTRO</span><span class="si">}</span>-rviz2
</code></pre></div>
<p>If you find an error trying to install these dependencies, most probably you'll need to update the packages repositories and upgrade them to the last version</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>sudo<span class="w"> </span>apt<span class="w"> </span>update
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>sudo<span class="w"> </span>apt<span class="w"> </span>upgrade
</code></pre></div>
<p>Once the dependencies are correctly installed, you can compile the workspace</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>cdw
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>cb
</code></pre></div>
<h3 id="21-test-the-uma-manipulator-package">2.1. Test the UMA manipulator package<a class="headerlink" href="#21-test-the-uma-manipulator-package" title="Permanent link">Â¶</a></h3>
<p>Open one terminal and run:
</p><div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>ros2<span class="w"> </span>launch<span class="w"> </span>uma_arm_description<span class="w"> </span>uma_arm_visualization.launch.py
</code></pre></div>
<p>You'll see RViz2 openning and showing the following:</p>
<p><img alt="rviz2_uma_arm" src="images/rviz2_uma_arm.png"></p>
<p>You can open a new terminal and run the <code>joint_state_publisher_gui</code>to move joints of the robot</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>ros2<span class="w"> </span>run<span class="w"> </span>joint_state_publisher_gui<span class="w"> </span>joint_state_publisher_gui<span class="w"> </span>
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If you press <code>ctrl + shift + o</code> or <code>ctrl + shift + e</code> in the terminator terminal, it will split the terminals vertically or horizontally </p>
</div>
<p>Now, you should have the following in your terminals</p>
<p><img alt="terminals_test_uma_arm" src="images/terminals_test_uma_arm.png"></p>
<p>A GUI should have opened now allowing you to manually drive the joints of the manipulator</p>
<p><div class="video-container"><video style="width:100%" loop muted autoplay alt="type:video"><source src="videos/video_gui.mp4" type="video/mp4"></source></video></div></p>
<div class="admonition success">
<p class="admonition-title">Success</p>
<p>Great work! Now you are ready to do the Lab session 2!</p>
</div>
<p>You can also close all the terminals (press <code>ctrl + c</code>).</p>
<hr>
<h2 id="3-simulate-the-robot-dynamics">3. Simulate the robot dynamics<a class="headerlink" href="#3-simulate-the-robot-dynamics" title="Permanent link">Â¶</a></h2>
<p>The manipulator model you've loaded is purely a kinematic visualization (i.e., there is no dynamics - no forces, and there is no simulation)</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>RViz 2 is 3D visualization tool, not a simulator. It means it allows you to see the robot models, sensor data, and other information shared in your ROS 2 environment in real-time and offers you a GUI to select the information to be visualize, but it is NOT a simulation</p>
</div>
<p>There are different ways to simulate the dynamics. The (probably) most straightforard one is to use a simulator as <a href="https://gazebosim.org/home">Gazebo</a>. However, as we are roboticists and want to see, touch, and learn the intrinsic effects of the dynamics of the robotic manipulator, we'll code the dynamics (the equations of motion) of the manipulator down into a node.</p>
<h3 id="31-clone-the-uma_arm_control-package">3.1. Clone the uma_arm_control package<a class="headerlink" href="#31-clone-the-uma_arm_control-package" title="Permanent link">Â¶</a></h3>
<p>To do this, we'll work with another package. You have to do the following</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>cdw
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="nb">cd</span><span class="w"> </span>src
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/jmgandarias/uma_arm_control.git
</code></pre></div>
<p>Once you have done this, your workspace folder should look like this</p>
<p><img alt="workspace_folders" src="images/workspace_folders.png"></p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You can open the Ubuntu file manager even if you're using WSL running nautilus in a terminal
</p><div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>nautilus
</code></pre></div>
</div>
<p>Now you can compile your workspace
</p><div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>cdw
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>cb
</code></pre></div>
<div class="admonition success">
<p class="admonition-title">Success</p>
<p>Great work! You're now ready to implement the manipulator dynamics</p>
</div>
<p>But first, let's have a look at the <code>uma_arm_control</code> package distribution</p>
<h3 id="32-understanding-the-uma_arm_control-package">3.2. Understanding the uma_arm_control package<a class="headerlink" href="#32-understanding-the-uma_arm_control-package" title="Permanent link">Â¶</a></h3>
<p>The package is structured as shown in the following image</p>
<p><img alt="uma_arm_control_structure" src="images/uma_arm_control_structure.png"></p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You can directly open VSCode inside WSL by running <code>code</code> in a terminal</p>
</div>
<ul>
<li>
<p><strong>config</strong></p>
<p>This folder contains configuration files that define various parameters. </p>
<ul>
<li><strong>dynamics_params.yaml</strong>: This file contains parameters related to the dynamics of the robotic arm. <em><img alt="ð" class="twemoji" src="../assets/external/cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f4dd.svg" title=":pencil:"> You need to modify it in this lab.</em></li>
<li><strong>impedance_params.yaml</strong>: This file includes parameters for the impedance controller. <em><img alt="ð" class="twemoji" src="../assets/external/cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f4c6.svg" title=":calendar:"> You'll need to modify it in future sessions.</em></li>
</ul>
</li>
<li>
<p><strong>launch</strong></p>
<p>This folder contains launch scripts.</p>
<ul>
<li><strong>uma_arm_dynamics_launch.py</strong>: This Python script launches the dynamics simulation node for the robotic arm. <em><img alt="ð" class="twemoji" src="../assets/external/cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f512.svg" title=":lock:"> You don't have to modify it.</em></li>
</ul>
</li>
<li>
<p><strong>src</strong></p>
<p>This folder contains the source code for the dynamics control and simulation of the robotic arm:</p>
<ul>
<li><strong>uma_arm_dynamics.cpp</strong>: This C++ file contains the implementation of the dynamics equations (equations of motion) for the robotic arm. <em><img alt="ð" class="twemoji" src="../assets/external/cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f4dd.svg" title=":pencil:"> You need to modify it in this lab.</em></li>
</ul>
</li>
<li>
<p><strong>utils:</strong> This folder contains utility scripts that provide additional functionalities for the labs. <em><img alt="ð" class="twemoji" src="../assets/external/cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f512.svg" title=":lock:"> You don't have to modify it.</em></p>
</li>
<li><strong>.gitignore:</strong> Specifies which files and directories should be ignored by Git version control. <em><img alt="ð" class="twemoji" src="../assets/external/cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f512.svg" title=":lock:"> You don't have to modify it.</em></li>
<li><strong>CMakeLists.txt:</strong> Contains instructions for building the project using CMake, a build system generator. <em><img alt="ð" class="twemoji" src="../assets/external/cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f4c6.svg" title=":calendar:"> You'll need to modify it in future sessions.</em></li>
<li><strong>LICENSE:</strong> The license file that specifies the terms under which the project can be used and distributed. <em><img alt="ð" class="twemoji" src="../assets/external/cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f512.svg" title=":lock:"> You don't have to modify it.</em></li>
<li><strong>package.xml:</strong> Defines the package metadata for ROS, including dependencies and other information. <em><img alt="ð" class="twemoji" src="../assets/external/cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f512.svg" title=":lock:"> You don't have to modify it.</em></li>
<li><strong>README.md:</strong> Provides an overview of the project, instructions for setup, usage, and other relevant information. <em><img alt="ð" class="twemoji" src="../assets/external/cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f4dd.svg" title=":pencil:"> You should modify it and keep it updated as you work on the lab sessions.</em></li>
</ul>
<h3 id="33-understanding-the-uma_arm_dynamicscpp-code">3.3. Understanding the uma_arm_dynamics.cpp code<a class="headerlink" href="#33-understanding-the-uma_arm_dynamicscpp-code" title="Permanent link">Â¶</a></h3>
<h5 id="331-libraries">3.3.1. Libraries <img alt="ð" class="twemoji" src="../assets/external/cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f512.svg" title=":lock:"><a class="headerlink" href="#331-libraries" title="Permanent link">Â¶</a></h5>
<p>Includes the needed libraries. You don't have to modify it.</p>
<details>
<summary>Show the code</summary>
<div class="highlight"><span class="filename">libraries.cpp</span><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="w">    </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;rclcpp/rclcpp.hpp&gt;</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="w">    </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sensor_msgs/msg/joint_state.hpp&gt;</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">    </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;std_msgs/msg/float64_multi_array.hpp&gt;</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">    </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;geometry_msgs/msg/wrench.hpp&gt;</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="w">    </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;chrono&gt;</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="w">    </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Eigen/Dense&gt;</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="w">    </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cmath&gt;</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">std</span><span class="o">::</span><span class="nn">chrono</span><span class="p">;</span>
</code></pre></div>
</details>

<h5 id="332-constructor">3.3.2. Constructor <img alt="ð" class="twemoji" src="../assets/external/cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f512.svg" title=":lock:"><a class="headerlink" href="#332-constructor" title="Permanent link">Â¶</a></h5>
<p><strong>ManipulatorDynamicsNode:</strong> Inherits from rclcpp::Node, making it a ROS 2 node. The class <code>ManipulatorDynamicsNode</code> is a ROS 2 node responsible for computing the dynamics of the manipulator (robot arm). You don't have to modify it.</p>
<p><strong>ManipulatorDynamicsNode():</strong> Class constructor that Initializes the node with the name <code>manipulator_dynamics_node</code>.</p>
<details>
<summary>Show the code</summary>
<div class="highlight"><span class="filename">constructor_initialization</span><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="nc">ManipulatorDynamicsNode</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="w">    </span><span class="k">public</span><span class="o">:</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="w">        </span><span class="n">ManipulatorDynamicsNode</span><span class="p">()</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="w">            </span><span class="o">:</span><span class="w"> </span><span class="n">Node</span><span class="p">(</span><span class="s">"manipulator_dynamics_node"</span><span class="p">),</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="w">              </span><span class="n">joint_positions_</span><span class="p">(</span><span class="n">Eigen</span><span class="o">::</span><span class="n">VectorXd</span><span class="o">::</span><span class="n">Zero</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="w">              </span><span class="n">joint_velocities_</span><span class="p">(</span><span class="n">Eigen</span><span class="o">::</span><span class="n">VectorXd</span><span class="o">::</span><span class="n">Zero</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="w">              </span><span class="n">joint_accelerations_</span><span class="p">(</span><span class="n">Eigen</span><span class="o">::</span><span class="n">VectorXd</span><span class="o">::</span><span class="n">Zero</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="w">              </span><span class="n">joint_torques_</span><span class="p">(</span><span class="n">Eigen</span><span class="o">::</span><span class="n">VectorXd</span><span class="o">::</span><span class="n">Zero</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="w">              </span><span class="n">external_wrenches_</span><span class="p">(</span><span class="n">Eigen</span><span class="o">::</span><span class="n">VectorXd</span><span class="o">::</span><span class="n">Zero</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span>
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="w">              </span><span class="n">previous_time_</span><span class="p">(</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">())</span>
<a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a><span class="w">            </span><span class="c1">// Frequency initialization</span>
<a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a><span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">declare_parameter</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"frequency"</span><span class="p">,</span><span class="w"> </span><span class="mf">1000.0</span><span class="p">);</span>
<a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a>
<a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a><span class="w">            </span><span class="c1">// Dynamics parameters initialization</span>
<a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a><span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">declare_parameter</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"m1"</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">);</span>
<a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a><span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">declare_parameter</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"m2"</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">);</span>
<a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a><span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">declare_parameter</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"l1"</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">);</span>
<a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a><span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">declare_parameter</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"l2"</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">);</span>
<a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a><span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">declare_parameter</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"b1"</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">);</span>
<a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a><span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">declare_parameter</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"b2"</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">);</span>
<a id="__codelineno-14-23" name="__codelineno-14-23" href="#__codelineno-14-23"></a><span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">declare_parameter</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"g"</span><span class="p">,</span><span class="w"> </span><span class="mf">9.81</span><span class="p">);</span>
<a id="__codelineno-14-24" name="__codelineno-14-24" href="#__codelineno-14-24"></a><span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">declare_parameter</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="s">"q0"</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">});</span>
<a id="__codelineno-14-25" name="__codelineno-14-25" href="#__codelineno-14-25"></a>
<a id="__codelineno-14-26" name="__codelineno-14-26" href="#__codelineno-14-26"></a><span class="w">            </span><span class="c1">// Get frequency [Hz] parameter and compute period [s]</span>
<a id="__codelineno-14-27" name="__codelineno-14-27" href="#__codelineno-14-27"></a><span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">frequency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_parameter</span><span class="p">(</span><span class="s">"frequency"</span><span class="p">).</span><span class="n">as_double</span><span class="p">();</span>
<a id="__codelineno-14-28" name="__codelineno-14-28" href="#__codelineno-14-28"></a>
<a id="__codelineno-14-29" name="__codelineno-14-29" href="#__codelineno-14-29"></a><span class="w">            </span><span class="c1">// Get dynamic parameters</span>
<a id="__codelineno-14-30" name="__codelineno-14-30" href="#__codelineno-14-30"></a><span class="w">            </span><span class="n">m1_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_parameter</span><span class="p">(</span><span class="s">"m1"</span><span class="p">).</span><span class="n">as_double</span><span class="p">();</span>
<a id="__codelineno-14-31" name="__codelineno-14-31" href="#__codelineno-14-31"></a><span class="w">            </span><span class="n">m2_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_parameter</span><span class="p">(</span><span class="s">"m2"</span><span class="p">).</span><span class="n">as_double</span><span class="p">();</span>
<a id="__codelineno-14-32" name="__codelineno-14-32" href="#__codelineno-14-32"></a><span class="w">            </span><span class="n">l1_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_parameter</span><span class="p">(</span><span class="s">"l1"</span><span class="p">).</span><span class="n">as_double</span><span class="p">();</span>
<a id="__codelineno-14-33" name="__codelineno-14-33" href="#__codelineno-14-33"></a><span class="w">            </span><span class="n">l2_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_parameter</span><span class="p">(</span><span class="s">"l2"</span><span class="p">).</span><span class="n">as_double</span><span class="p">();</span>
<a id="__codelineno-14-34" name="__codelineno-14-34" href="#__codelineno-14-34"></a><span class="w">            </span><span class="n">g_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_parameter</span><span class="p">(</span><span class="s">"g"</span><span class="p">).</span><span class="n">as_double</span><span class="p">();</span>
<a id="__codelineno-14-35" name="__codelineno-14-35" href="#__codelineno-14-35"></a><span class="w">            </span><span class="n">b1_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_parameter</span><span class="p">(</span><span class="s">"b1"</span><span class="p">).</span><span class="n">as_double</span><span class="p">();</span>
<a id="__codelineno-14-36" name="__codelineno-14-36" href="#__codelineno-14-36"></a><span class="w">            </span><span class="n">b2_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_parameter</span><span class="p">(</span><span class="s">"b2"</span><span class="p">).</span><span class="n">as_double</span><span class="p">();</span>
<a id="__codelineno-14-37" name="__codelineno-14-37" href="#__codelineno-14-37"></a>
<a id="__codelineno-14-38" name="__codelineno-14-38" href="#__codelineno-14-38"></a><span class="w">            </span><span class="c1">// Set initial joint position</span>
<a id="__codelineno-14-39" name="__codelineno-14-39" href="#__codelineno-14-39"></a><span class="w">            </span><span class="n">joint_positions_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Eigen</span><span class="o">::</span><span class="n">VectorXd</span><span class="o">::</span><span class="n">Map</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_parameter</span><span class="p">(</span><span class="s">"q0"</span><span class="p">).</span><span class="n">as_double_array</span><span class="p">().</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
</code></pre></div>
</details>

<p><strong>Member variables initialization</strong></p>
<ul>
<li><code>joint_positions_</code>, <code>joint_velocities_</code>, <code>joint_accelerations_</code>, <code>joint_torques_</code>, <code>external_wrenches_</code>: These are Eigen vectors initialized to zero. We'll use the library <a href="https://eigen.tuxfamily.org/index.php?title=Main_Page">Eigen</a> to work with vectors and matrices in C++.</li>
<li><code>previous_time_</code>: Initialized to the current time using high_resolution_clock::now().</li>
</ul>
<p><strong>Parameters declaration</strong></p>
<ul>
<li><code>frequency</code>: The frequency at which the node operates (default 1000 Hz).</li>
<li><code>m1</code>, <code>m2</code>: Masses of the manipulator's links.</li>
<li><code>l1</code>, <code>l2</code>: Lengths of the manipulator's links.</li>
<li><code>b1</code>, <code>b2</code>: Damping coefficients.</li>
<li><code>g</code>: Gravitational acceleration.</li>
<li><code>q0</code>: Initial joint positions.</li>
</ul>
<p><strong>Parameters Retrieval</strong></p>
<ul>
<li><code>get_parameter</code>: Retrieves the values of the declared parameters and assigns them to member variables. The values of the parameters are defined in the <code>dynamics_params.yaml</code> file inside the config folder.</li>
</ul>
<p><strong>Setting Initial Joint Positions</strong></p>
<ul>
<li><code>joint_positions_</code>: Sets the initial joint positions using the parameter q0.</li>
</ul>
<details>
<summary>Show the code</summary>
<div class="highlight"><span class="filename">constructor_publisher_subscriber</span><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="w">     </span><span class="c1">// Create subscription to joint_torques</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="w">     </span><span class="n">joint_torques_subscription_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">create_subscription</span><span class="o">&lt;</span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Float64MultiArray</span><span class="o">&gt;</span><span class="p">(</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="w">        </span><span class="s">"joint_torques"</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ManipulatorDynamicsNode</span><span class="o">::</span><span class="n">joint_torques_callback</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">));</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="w">    </span><span class="c1">// Create subscription to external wrenches</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="w">    </span><span class="n">external_wrenches_subscription_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">create_subscription</span><span class="o">&lt;</span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Wrench</span><span class="o">&gt;</span><span class="p">(</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="w">        </span><span class="s">"external_wrenches"</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ManipulatorDynamicsNode</span><span class="o">::</span><span class="n">external_wrenches_callback</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">));</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="w">    </span><span class="c1">// Create publisher for joint acceleration</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="w">    </span><span class="n">publisher_acceleration_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">create_publisher</span><span class="o">&lt;</span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Float64MultiArray</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"joint_accelerations"</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="w">    </span><span class="c1">// Create publisher for joint state</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a><span class="w">    </span><span class="n">publisher_joint_state_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">create_publisher</span><span class="o">&lt;</span><span class="n">sensor_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">JointState</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"joint_states"</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a><span class="w">    </span><span class="c1">// Set the timer callback at a period (in milliseconds, multiply it by 1000)</span>
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a><span class="w">    </span><span class="n">timer_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">create_wall_timer</span><span class="p">(</span>
<a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1000</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">frequency</span><span class="p">)),</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ManipulatorDynamicsNode</span><span class="o">::</span><span class="n">timer_callback</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">));</span>
<a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a><span class="w">    </span><span class="p">}</span>
</code></pre></div>
</details>

<p><strong>Subscriptions</strong></p>
<ul>
<li><code>joint_torques_subscription_</code>: Subscribes to the <code>joint_torques</code> topic, which is expected to publish messages of type <code>std_msgs::msg::Float64MultiArray</code>. The callback function <code>joint_torques_callback</code> is bound to handle incoming messages.</li>
<li><code>external_wrenches_subscription_</code>: Subscribes to the <code>external_wrenches</code> topic, which is expected to publish messages of type- <code>geometry_msgs::msg::Wrench</code>. The callback function <code>external_wrenches_callback</code> is bound to handle incoming messages.</li>
</ul>
<p><strong>Publishers</strong></p>
<ul>
<li><code>publisher_acceleration_</code>: Creates a publisher for the <code>joint_accelerations</code> topic, which will publish messages of type <code>std_msgs::msg::Float64MultiArray</code>.</li>
<li><code>publisher_joint_state_</code>: Creates a publisher for the <code>joint_states</code> topic, which will publish messages of type <code>sensor_msgs::msg::JointState</code>.</li>
</ul>
<p><strong>Timer</strong></p>
<ul>
<li><code>timer_</code>: Sets up a timer that triggers the <code>timer_callback</code> function (explained below) at a period determined by the frequency parameter. The period is expected to be given in milliseconds, therefore, it is calculated as </li>
</ul>
<div class="arithmatex">\[
period \, \text{[ms]} = \frac{1 \, [\cancel{\text{s}}] \cdot 1000 \, [\text{ms}/\cancel{\text{s}}]}{frequency \, [\text{Hz}]} 
\]</div>
<h5 id="333-timer-callback">3.3.3. Timer callback <img alt="ð" class="twemoji" src="../assets/external/cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f512.svg" title=":lock:"><a class="headerlink" href="#333-timer-callback" title="Permanent link">Â¶</a></h5>
<p>The <code>timer_callback</code> function is responsible for:</p>
<ul>
<li>Calculating the <code>elapsed_time_</code> between callbacks.</li>
<li>Updating the new <code>joint_accelerations_</code>, <code>joint_velocities_</code>, and <code>joint_positions_</code> using the respective functions (you'll need to implement these functions later).</li>
<li>Publishing the updated joint states to the ROS topics.</li>
</ul>
<p>This function ensures that the manipulator's state is updated and communicated at regular intervals based on the timer's frequency.</p>
<details>
<summary>Show the code</summary>
<div class="highlight"><span class="filename">timer_callback</span><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="w">    </span><span class="c1">// Timer callback - when there is a timer callback, computes the new joint acceleration, velocity and position and publishes them</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">timer_callback</span><span class="p">()</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">    </span><span class="c1">// Get the actual elapsed time</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">current_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="w">    </span><span class="n">elapsed_time_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">duration</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">current_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">previous_time_</span><span class="p">).</span><span class="n">count</span><span class="p">();</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="w">    </span><span class="n">previous_time_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_time</span><span class="p">;</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="w">    </span><span class="c1">// Calculate JointState</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="w">    </span><span class="n">joint_accelerations_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calculate_acceleration</span><span class="p">();</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="w">    </span><span class="n">joint_velocities_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calculate_velocity</span><span class="p">();</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="w">    </span><span class="n">joint_positions_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calculate_position</span><span class="p">();</span>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="w">    </span><span class="c1">// Publish data</span>
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="w">    </span><span class="n">publish_data</span><span class="p">();</span>
<a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a><span class="w">    </span><span class="p">}</span>
</code></pre></div>
</details>

<h5 id="334-topic-callbacks">3.3.4. Topic callbacks <img alt="ð" class="twemoji" src="../assets/external/cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f512.svg" title=":lock:"><a class="headerlink" href="#334-topic-callbacks" title="Permanent link">Â¶</a></h5>
<p>These callback functions ensure that the node's state is updated with the latest data from the subscribed topics. Specifically:</p>
<ul>
<li><code>joint_torques_callback</code>: Updates the <code>joint_torques_</code>  based on incoming messages.</li>
<li><code>external_wrenches_callback</code>: Updates the <code>external_wrenches_</code> based on incoming messages.</li>
</ul>
<details>
<summary>Show the code</summary>
<div class="highlight"><span class="filename">topic_callbacks</span><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="w">    </span><span class="k">private</span><span class="o">:</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="w">        </span><span class="c1">// Subscription callback - when a new message arrives, updates joint_torques_</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="n">joint_torques_callback</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Float64MultiArray</span><span class="o">::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="w">            </span><span class="n">joint_torques_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Eigen</span><span class="o">::</span><span class="n">VectorXd</span><span class="o">::</span><span class="n">Map</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="w">        </span><span class="c1">// Subscription callback - when a new message arrives, updates external_wrenches_</span>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="n">external_wrenches_callback</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Wrench</span><span class="o">::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">forces</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">force</span><span class="p">;</span>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="w">            </span><span class="n">external_wrenches_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">forces</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a><span class="w">            </span><span class="n">external_wrenches_</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">forces</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a><span class="w">        </span><span class="p">}</span>
</code></pre></div>
</details>

<h5 id="335-calculate-acceleration">3.3.5. Calculate acceleration <img alt="ð" class="twemoji" src="../assets/external/cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f4dd.svg" title=":pencil:"><a class="headerlink" href="#335-calculate-acceleration" title="Permanent link">Â¶</a></h5>
<p>This method computes the <code>joint_accelerations_</code> of the manipulator by considering the equations of motion, including inertia, Coriolis and centrifugal forces, friction, gravitational forces, and external torques. You have to implement it as explained later.</p>
<p>At the moment, the method returns <span class="arithmatex">\(\mathbf{\ddot{q}} = [0, 0]\)</span>.</p>
<details>
<summary>Show the code</summary>
<div class="highlight"><span class="filename">calculate_acceleration</span><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="w">    </span><span class="c1">// Method to calculate joint acceleration</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="w">    </span><span class="n">Eigen</span><span class="o">::</span><span class="n">VectorXd</span><span class="w"> </span><span class="nf">calculate_acceleration</span><span class="p">()</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="w">        </span><span class="c1">// Initialize M, C, Fb, g_vec, J, and tau_ext</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="w">        </span><span class="c1">// Initialize q1, q2, q_dot1, and q_dot2</span>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="w">        </span><span class="c1">// Placeholder calculations for M, C, Fb, g, and tau_ext</span>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="w">        </span><span class="c1">// Calculate matrix M</span>
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a>
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="w">        </span><span class="c1">// Calculate vector C (C is 2x1 because it already includes q_dot)</span>
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a>
<a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="w">        </span><span class="c1">// Calculate Fb matrix</span>
<a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a>
<a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a><span class="w">        </span><span class="c1">// Calculate g_vect</span>
<a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a>
<a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a><span class="w">        </span><span class="c1">// Calculate J</span>
<a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a>
<a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a><span class="w">        </span><span class="c1">// Calculate tau_ext</span>
<a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a>
<a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a><span class="w">        </span><span class="c1">// Calculate joint accelerations using the dynamic model: q'' = M^(-1)[tau - C(q,q')q' - Fbq' - g(q) + tau_ext]</span>
<a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a><span class="w">        </span><span class="n">Eigen</span><span class="o">::</span><span class="n">VectorXd</span><span class="w"> </span><span class="n">q_ddot</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a><span class="w">        </span><span class="n">q_ddot</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-18-25" name="__codelineno-18-25" href="#__codelineno-18-25"></a>
<a id="__codelineno-18-26" name="__codelineno-18-26" href="#__codelineno-18-26"></a><span class="w">        </span><span class="c1">// Return joint accelerations</span>
<a id="__codelineno-18-27" name="__codelineno-18-27" href="#__codelineno-18-27"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">q_ddot</span><span class="p">;</span>
<a id="__codelineno-18-28" name="__codelineno-18-28" href="#__codelineno-18-28"></a><span class="w">    </span><span class="p">}</span>
</code></pre></div>
</details>

<h5 id="336-integrate-position-and-velocity">3.3.6. Integrate position and velocity <img alt="ð" class="twemoji" src="../assets/external/cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f4dd.svg" title=":pencil:"><a class="headerlink" href="#336-integrate-position-and-velocity" title="Permanent link">Â¶</a></h5>
<p>This method computes the joint velocities and positions by integrating over the elapsed time. You have to implement it as explained later.</p>
<p>At the moment, the methods return <span class="arithmatex">\(\mathbf{\dot{q}} = \mathbf{q} = [0, 0]\)</span>.</p>
<details>
<summary>Show the code</summary>
<div class="highlight"><span class="filename">Integrate_vel_pos</span><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="w">     </span><span class="c1">// Method to calculate joint velocity</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="w">     </span><span class="n">Eigen</span><span class="o">::</span><span class="n">VectorXd</span><span class="w"> </span><span class="nf">calculate_velocity</span><span class="p">()</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="w">     </span><span class="p">{</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="w">         </span><span class="c1">// Placeholder for velocity calculation</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="w">         </span><span class="c1">// Integrate velocity over the time step (elapsed_time_)</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="w">         </span><span class="n">Eigen</span><span class="o">::</span><span class="n">VectorXd</span><span class="w"> </span><span class="n">q_dot</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="w">         </span><span class="n">q_dot</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a>
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="w">         </span><span class="k">return</span><span class="w"> </span><span class="n">q_dot</span><span class="p">;</span>
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="w">     </span><span class="p">}</span>
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a>
<a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="w">     </span><span class="c1">// Method to calculate joint position</span>
<a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a><span class="w">     </span><span class="n">Eigen</span><span class="o">::</span><span class="n">VectorXd</span><span class="w"> </span><span class="nf">calculate_position</span><span class="p">()</span>
<a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="w">     </span><span class="p">{</span>
<a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a><span class="w">         </span><span class="c1">// Placeholder for position calculation</span>
<a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a><span class="w">         </span><span class="c1">// Integrate position over the time step (elapsed_time_)</span>
<a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a><span class="w">         </span><span class="n">Eigen</span><span class="o">::</span><span class="n">VectorXd</span><span class="w"> </span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a><span class="w">         </span><span class="n">q</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a>
<a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a><span class="w">         </span><span class="k">return</span><span class="w"> </span><span class="n">q</span><span class="p">;</span>
<a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a><span class="w">     </span><span class="p">}</span>
</code></pre></div>
</details>

<h5 id="337-publish-the-data">3.3.7. Publish the data <img alt="ð" class="twemoji" src="../assets/external/cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f512.svg" title=":lock:"><a class="headerlink" href="#337-publish-the-data" title="Permanent link">Â¶</a></h5>
<p>This method is responsible for publishing the computed <code>joint_accelerations_</code> and <code>joint_state</code> (<code>joint_positions_</code> and <code>joint_velocities_</code>) to their respective topics.</p>
<details>
<summary>Show the code</summary>
<div class="highlight"><span class="filename">publish_data</span><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="w">    </span><span class="c1">// Method to publish the joint data</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">publish_data</span><span class="p">()</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="w">        </span><span class="c1">// publish joint acceleration</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">acceleration_msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Float64MultiArray</span><span class="p">();</span>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="w">        </span><span class="n">acceleration_msg</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">assign</span><span class="p">(</span><span class="n">joint_accelerations_</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">joint_accelerations_</span><span class="p">.</span><span class="n">data</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">joint_accelerations_</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="w">        </span><span class="n">publisher_acceleration_</span><span class="o">-&gt;</span><span class="n">publish</span><span class="p">(</span><span class="n">acceleration_msg</span><span class="p">);</span>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a>
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a><span class="w">        </span><span class="c1">// publish joint state</span>
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">joint_state_msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sensor_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">JointState</span><span class="p">();</span>
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a><span class="w">        </span><span class="n">joint_state_msg</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_clock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">now</span><span class="p">();</span>
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="w">        </span><span class="n">joint_state_msg</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">"joint_1"</span><span class="p">,</span><span class="w"> </span><span class="s">"joint_2"</span><span class="p">};</span><span class="w"> </span><span class="c1">// Replace with actual joint names</span>
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a><span class="w">        </span><span class="n">joint_state_msg</span><span class="p">.</span><span class="n">position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">joint_positions_</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">joint_positions_</span><span class="p">(</span><span class="mi">1</span><span class="p">)};</span>
<a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a><span class="w">        </span><span class="n">joint_state_msg</span><span class="p">.</span><span class="n">velocity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">joint_velocities_</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">joint_velocities_</span><span class="p">(</span><span class="mi">1</span><span class="p">)};</span>
<a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a><span class="w">        </span><span class="n">publisher_joint_state_</span><span class="o">-&gt;</span><span class="n">publish</span><span class="p">(</span><span class="n">joint_state_msg</span><span class="p">);</span>
<a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a><span class="w">    </span><span class="p">}</span>
</code></pre></div>
</details>

<h4 id="338-member-variables">3.3.8. Member variables<a class="headerlink" href="#338-member-variables" title="Permanent link">Â¶</a></h4>
<p>Defines the member variables for the ManipulatorDynamicsNode class. Here's a detailed breakdown of these variables:
Member Variables</p>
<details>
<summary>Show the code</summary>
<div class="highlight"><span class="filename">member_variables</span><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="w">    </span><span class="c1">// Member variables</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="w">        </span><span class="c1">// Publishers and subscribers</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="w">        </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Subscription</span><span class="o">&lt;</span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Float64MultiArray</span><span class="o">&gt;::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">joint_torques_subscription_</span><span class="p">;</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="w">        </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Subscription</span><span class="o">&lt;</span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Wrench</span><span class="o">&gt;::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">external_wrenches_subscription_</span><span class="p">;</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="w">        </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Publisher</span><span class="o">&lt;</span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Float64MultiArray</span><span class="o">&gt;::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">publisher_acceleration_</span><span class="p">;</span>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="w">        </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Publisher</span><span class="o">&lt;</span><span class="n">sensor_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">JointState</span><span class="o">&gt;::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">publisher_joint_state_</span><span class="p">;</span>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="w">        </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">TimerBase</span><span class="o">::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">timer_</span><span class="p">;</span>
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a>
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a><span class="w">        </span><span class="c1">// Joint variables</span>
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a><span class="w">        </span><span class="n">Eigen</span><span class="o">::</span><span class="n">VectorXd</span><span class="w"> </span><span class="n">joint_positions_</span><span class="p">;</span>
<a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a><span class="w">        </span><span class="n">Eigen</span><span class="o">::</span><span class="n">VectorXd</span><span class="w"> </span><span class="n">joint_velocities_</span><span class="p">;</span>
<a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a><span class="w">        </span><span class="n">Eigen</span><span class="o">::</span><span class="n">VectorXd</span><span class="w"> </span><span class="n">joint_accelerations_</span><span class="p">;</span>
<a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a><span class="w">        </span><span class="n">Eigen</span><span class="o">::</span><span class="n">VectorXd</span><span class="w"> </span><span class="n">joint_torques_</span><span class="p">;</span>
<a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a><span class="w">        </span><span class="n">Eigen</span><span class="o">::</span><span class="n">VectorXd</span><span class="w"> </span><span class="n">external_wrenches_</span><span class="p">;</span>
<a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a>
<a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a><span class="w">        </span><span class="c1">// dynamic parameters variables</span>
<a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">m1_</span><span class="p">;</span>
<a id="__codelineno-21-18" name="__codelineno-21-18" href="#__codelineno-21-18"></a><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">m2_</span><span class="p">;</span>
<a id="__codelineno-21-19" name="__codelineno-21-19" href="#__codelineno-21-19"></a><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">l1_</span><span class="p">;</span>
<a id="__codelineno-21-20" name="__codelineno-21-20" href="#__codelineno-21-20"></a><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">l2_</span><span class="p">;</span>
<a id="__codelineno-21-21" name="__codelineno-21-21" href="#__codelineno-21-21"></a><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">b1_</span><span class="p">;</span>
<a id="__codelineno-21-22" name="__codelineno-21-22" href="#__codelineno-21-22"></a><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">b2_</span><span class="p">;</span>
<a id="__codelineno-21-23" name="__codelineno-21-23" href="#__codelineno-21-23"></a><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">g_</span><span class="p">;</span>
<a id="__codelineno-21-24" name="__codelineno-21-24" href="#__codelineno-21-24"></a>
<a id="__codelineno-21-25" name="__codelineno-21-25" href="#__codelineno-21-25"></a><span class="w">        </span><span class="c1">// Variable to store the previous callback time and elapsed time</span>
<a id="__codelineno-21-26" name="__codelineno-21-26" href="#__codelineno-21-26"></a><span class="w">        </span><span class="n">time_point</span><span class="o">&lt;</span><span class="n">high_resolution_clock</span><span class="o">&gt;</span><span class="w"> </span><span class="n">previous_time_</span><span class="p">;</span>
<a id="__codelineno-21-27" name="__codelineno-21-27" href="#__codelineno-21-27"></a><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">elapsed_time_</span><span class="p">;</span>
<a id="__codelineno-21-28" name="__codelineno-21-28" href="#__codelineno-21-28"></a><span class="w">    </span><span class="p">};</span>
</code></pre></div>
</details>

<p><strong>Publishers and Subscribers</strong></p>
<ul>
<li><code>joint_torques_subscription_</code>: Subscription to the "joint_torques" topic.</li>
<li><code>external_wrenches_subscription_</code>: Subscription to the "external_wrenches" topic.</li>
<li><code>publisher_acceleration_</code>: Publisher for the "joint_accelerations" topic.</li>
<li><code>publisher_joint_state_</code>: Publisher for the "joint_states" topic.</li>
</ul>
<p><strong>Joint Variables</strong></p>
<ul>
<li><code>joint_positions_</code>: Eigen vector representing the positions of the joints (<span class="arithmatex">\(\mathbf{q}\)</span>).</li>
<li><code>joint_velocities_</code>: Eigen vector representing the velocities of the joints (<span class="arithmatex">\(\mathbf{\dot{q}}\)</span>).</li>
<li><code>joint_accelerations_</code>: Eigen vector representing the accelerations of the joints (<span class="arithmatex">\(\mathbf{\ddot{q}}\)</span>).</li>
<li><code>joint_torques_</code>: Eigen vector representing the torques applied to the joints (<span class="arithmatex">\(\boldsymbol{\tau}\)</span>).</li>
<li><code>external_wrenches_</code>: Eigen vector representing the external forces and torques applied to the EE (<span class="arithmatex">\(\mathbf{F}_{ext}\)</span>).</li>
</ul>
<p><strong>Dynamic Parameters Variables</strong></p>
<ul>
<li><code>m1_</code>: Mass of the first link of the manipulator.</li>
<li><code>m2_</code>: Mass of the second link of the manipulator.</li>
<li><code>l1_</code>: Length of the first link of the manipulator.</li>
<li><code>l2_</code>: Length of the second link of the manipulator.</li>
<li><code>b1_</code>: Damping coefficient for the first joint.</li>
<li><code>b2_</code>: Damping coefficient for the second joint.</li>
<li><code>g_</code>: Gravitational acceleration.</li>
</ul>
<p><strong>Time Variables</strong></p>
<ul>
<li><code>timer_</code>: Timer that triggers the timer_callback function at a specified frequency.</li>
<li><code>previous_time_</code>: Stores the time of the previous callback execution.</li>
<li><code>elapsed_time_</code>: Stores the elapsed time between the current and previous callback executions (<span class="arithmatex">\(\Delta t\)</span>).</li>
</ul>
<h4 id="339-main">3.3.9. Main<a class="headerlink" href="#339-main" title="Permanent link">Â¶</a></h4>
<p>Initializes the ROS 2 node, creates a shared pointer to an instance of the <code>ManipulatorDynamicsNode</code> class, keeps the node running, and shuts down the ROS 2 node when the node execution finishes.</p>
<details>
<summary>Show the code</summary>
<div class="highlight"><span class="filename">main</span><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="w">        </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">);</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">ManipulatorDynamicsNode</span><span class="o">&gt;</span><span class="p">();</span>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="w">        </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="w">        </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="w">    </span><span class="p">}</span>
</code></pre></div>
</details>

<h3 id="34-implementing-the-dynamics-model">3.4. Implementing the dynamics model<a class="headerlink" href="#34-implementing-the-dynamics-model" title="Permanent link">Â¶</a></h3>
<p>The dynamics of an open kinematic chain robotic manipulator is given by </p>
<div class="arithmatex">\[
\mathbf{M}(\mathbf{q}) \ddot{\mathbf{q}} + \mathbf{C}(\mathbf{q}, \dot{\mathbf{q}}) \dot{\mathbf{q}} +  \mathbf{F}_b \dot{\mathbf{q}} + \mathbf{g}(\mathbf{q}) = \boldsymbol{\tau} + \boldsymbol{\tau}_{ext}
\]</div>
<p>where</p>
<ul>
<li><span class="arithmatex">\(\mathbf{q} \in \mathbb{R}^{n \times 1}\)</span> is the vector of joint positions (<code>joint_positions_</code>).</li>
<li><span class="arithmatex">\(\dot{\mathbf{q}} \in \mathbb{R}^{n \times 1}\)</span> is the vector of joint velocities (<code>joint_velocities_</code>).</li>
<li><span class="arithmatex">\(\ddot{\mathbf{q}} \in \mathbb{R}^{n \times 1}\)</span> is the vector of joint accelerations (<code>joint_accelerations_</code>).</li>
<li><span class="arithmatex">\(\mathbf{M}(\mathbf{q}) \in \mathbb{R}^{n \times n}\)</span> is the inertia matrix.</li>
<li><span class="arithmatex">\(\mathbf{C}(\mathbf{q}, \dot{\mathbf{q}}) \in \mathbb{R}^{n \times n}\)</span> is the Coriolis and centrifugal forces matrix.</li>
<li><span class="arithmatex">\(\mathbf{F}_b \in \mathbb{R}^{n \times n}\)</span> is the viscous friction matrix.</li>
<li><span class="arithmatex">\(\mathbf{g} \in \mathbb{R}^{n \times 1}\)</span> is the viscous friction matrix.</li>
<li><span class="arithmatex">\(\boldsymbol{\tau} \in \mathbb{R}^{n \times 1}\)</span> is the vector of commanded joint torques (<code>joint_torques_</code>).</li>
<li><span class="arithmatex">\(\boldsymbol{\tau}_{ext} \in \mathbb{R}^{n \times 1}\)</span> is the vector of joint torques due to external forces.</li>
</ul>
<p>In our case, as we have a 2 DoF manipulator, <span class="arithmatex">\(n=2\)</span>.</p>
<p>Hence, the acceleration due to applied torques is given by</p>
<div class="arithmatex">\[
\ddot{\mathbf{q}}  = \mathbf{M}^{-1}(\mathbf{q}) \left[  \boldsymbol{\tau} + \boldsymbol{\tau}_{ext} - \mathbf{C}(\mathbf{q}, \dot{\mathbf{q}}) \dot{\mathbf{q}} - \mathbf{F}_b \dot{\mathbf{q}} - \mathbf{g}(\mathbf{q}) \right]
\]</div>
<p>To calculate the joint accelerations, we first need to compute the matrices. They can be computed applying the Lagrange or the Newton-Euler formulations. In our case, the matrices are defined by:</p>
<div class="arithmatex">\[
\mathbf{M}(\mathbf{q}) =\begin{bmatrix}
&amp; \\
m_1 \cdot l_1^2 + m_2 \cdot (l_1^2 + 2 \cdot l_1 \cdot l_2 \cdot \cos(q_2) + l_2^2) &amp; m_2 \cdot (l_1 \cdot l_2 \cdot \cos(q_2) + l_2^2) \\ 
m_2 \cdot (l_1 \cdot l_2 \cdot \cos(q_2) + l_2^2) &amp; m_2 \cdot l_2^2\\
&amp; \\
\end{bmatrix}
\]</div>
<div class="arithmatex">\[
\mathbf{C}(\mathbf{q}, \dot{\mathbf{q}}) \dot{\mathbf{q}} = \begin{bmatrix}
&amp; \\
-m_2 \cdot l_1 \cdot l_2 \cdot \sin(q_2) \cdot (2 \cdot \dot{q}_1 \cdot \dot{q}_2 +\dot{q}_2^2) \\
m_2 \cdot l_1 \cdot l_2 \cdot \dot{q}_1^2 \cdot \sin(q_2)\\
&amp; \\
\end{bmatrix}
\]</div>
<div class="arithmatex">\[
\mathbf{F}_b = \begin{bmatrix}
&amp; \\
 b_1 &amp; 0\\
0 &amp; b_2\\
&amp; \\
\end{bmatrix}
\]</div>
<div class="arithmatex">\[
\mathbf{g}(\mathbf{q}) = \begin{bmatrix}
&amp; \\
(m_1 + m_2) \cdot l_1 \cdot g_ \cdot \cos(q_1) + m_2 \cdot g_ \cdot l_2 \cdot \cos(q_1 + q_2) \\
m_2 \cdot g \cdot l_2 \cdot \cos(q_1 + q_2)\\
&amp; \\
\end{bmatrix}
\]</div>
<p>We'll also need to compute the jacobian to include the external wrenches applied at the EE in our model</p>
<div class="arithmatex">\[
\mathbf{J}(\mathbf{q}) = \begin{bmatrix}
&amp; \\
-l_1 \cdot \sin(q_1) - l_2 \cdot \sin(q_1 + q_2) &amp; -l_2 \cdot \sin(q_1 + q_2) \\
l_1 \cdot \cos(q_1) + l_2 \cdot \cos(q_1 + q_2) &amp; l_2 \cdot \cos(q_1 + q_2)\\
&amp; \\
\end{bmatrix}
\]</div>
<p>Then, we can calculate <span class="arithmatex">\(\boldsymbol{\tau}_{ext}\)</span> as </p>
<div class="arithmatex">\[
\boldsymbol{\tau}_{ext} = \mathbf{J}(\mathbf{q})^T \cdot \mathbf{F}_{ext}
\]</div>
<p>We can now code them as</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="c1">// Initialize M, C, Fb, g_vec, J, and tau_ext</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="n">Eigen</span><span class="o">::</span><span class="n">MatrixXd</span><span class="w"> </span><span class="nf">M</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="n">Eigen</span><span class="o">::</span><span class="n">VectorXd</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="n">Eigen</span><span class="o">::</span><span class="n">MatrixXd</span><span class="w"> </span><span class="nf">Fb</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="n">Eigen</span><span class="o">::</span><span class="n">VectorXd</span><span class="w"> </span><span class="nf">g_vec</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a><span class="n">Eigen</span><span class="o">::</span><span class="n">MatrixXd</span><span class="w"> </span><span class="nf">J</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a><span class="n">Eigen</span><span class="o">::</span><span class="n">VectorXd</span><span class="w"> </span><span class="nf">tau_ext</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a><span class="c1">// Initialize q1, q2, q_dot1, and q_dot2</span>
<a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a><span class="kt">double</span><span class="w"> </span><span class="n">q1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">joint_positions_</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a><span class="kt">double</span><span class="w"> </span><span class="n">q2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">joint_positions_</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a><span class="kt">double</span><span class="w"> </span><span class="n">q_dot1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">joint_velocities_</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a><span class="kt">double</span><span class="w"> </span><span class="n">q_dot2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">joint_velocities_</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a>
<a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a><span class="c1">// Placeholder calculations for M, C, Fb, g, and tau_ext</span>
<a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a><span class="c1">// Calculate matrix M</span>
<a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a><span class="n">M</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m1_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pow</span><span class="p">(</span><span class="n">l1_</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">m2_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">pow</span><span class="p">(</span><span class="n">l1_</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l1_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l2_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cos</span><span class="p">(</span><span class="n">q2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pow</span><span class="p">(</span><span class="n">l2_</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">));</span>
<a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a><span class="n">M</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m2_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">l1_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l2_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cos</span><span class="p">(</span><span class="n">q2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pow</span><span class="p">(</span><span class="n">l2_</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">));</span>
<a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a><span class="n">M</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">M</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a><span class="n">M</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m2_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pow</span><span class="p">(</span><span class="n">l2_</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-23-21" name="__codelineno-23-21" href="#__codelineno-23-21"></a>
<a id="__codelineno-23-22" name="__codelineno-23-22" href="#__codelineno-23-22"></a><span class="c1">// Calculate vector C (C is 2x1 because it already includes q_dot)</span>
<a id="__codelineno-23-23" name="__codelineno-23-23" href="#__codelineno-23-23"></a><span class="n">C</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">-</span><span class="n">m2_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l1_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l2_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sin</span><span class="p">(</span><span class="n">q2</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">q_dot1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">q_dot2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pow</span><span class="p">(</span><span class="n">q_dot2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)),</span>
<a id="__codelineno-23-24" name="__codelineno-23-24" href="#__codelineno-23-24"></a><span class="n">m2_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l1_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l2_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pow</span><span class="p">(</span><span class="n">q_dot1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sin</span><span class="p">(</span><span class="n">q2</span><span class="p">);</span>
<a id="__codelineno-23-25" name="__codelineno-23-25" href="#__codelineno-23-25"></a>
<a id="__codelineno-23-26" name="__codelineno-23-26" href="#__codelineno-23-26"></a><span class="c1">// Calculate Fb matrix</span>
<a id="__codelineno-23-27" name="__codelineno-23-27" href="#__codelineno-23-27"></a><span class="n">Fb</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">b1_</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span>
<a id="__codelineno-23-28" name="__codelineno-23-28" href="#__codelineno-23-28"></a><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">b2_</span><span class="p">;</span>
<a id="__codelineno-23-29" name="__codelineno-23-29" href="#__codelineno-23-29"></a>
<a id="__codelineno-23-30" name="__codelineno-23-30" href="#__codelineno-23-30"></a><span class="c1">// Calculate g_vect</span>
<a id="__codelineno-23-31" name="__codelineno-23-31" href="#__codelineno-23-31"></a><span class="n">g_vec</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">m1_</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">m2_</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l1_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">g_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cos</span><span class="p">(</span><span class="n">q1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">m2_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">g_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l2_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cos</span><span class="p">(</span><span class="n">q1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">q2</span><span class="p">),</span>
<a id="__codelineno-23-32" name="__codelineno-23-32" href="#__codelineno-23-32"></a><span class="w">    </span><span class="n">m2_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">g_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l2_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cos</span><span class="p">(</span><span class="n">q1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">q2</span><span class="p">);</span>
<a id="__codelineno-23-33" name="__codelineno-23-33" href="#__codelineno-23-33"></a>
<a id="__codelineno-23-34" name="__codelineno-23-34" href="#__codelineno-23-34"></a><span class="c1">// Calculate J</span>
<a id="__codelineno-23-35" name="__codelineno-23-35" href="#__codelineno-23-35"></a><span class="n">J</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">-</span><span class="n">l1_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sin</span><span class="p">(</span><span class="n">q1</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">l2_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sin</span><span class="p">(</span><span class="n">q1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">q2</span><span class="p">),</span><span class="w"> </span><span class="o">-</span><span class="n">l2_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sin</span><span class="p">(</span><span class="n">q1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">q2</span><span class="p">),</span>
<a id="__codelineno-23-36" name="__codelineno-23-36" href="#__codelineno-23-36"></a><span class="w">    </span><span class="n">l1_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cos</span><span class="p">(</span><span class="n">q1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">l2_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cos</span><span class="p">(</span><span class="n">q1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">q2</span><span class="p">),</span><span class="w"> </span><span class="n">l2_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cos</span><span class="p">(</span><span class="n">q1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">q2</span><span class="p">);</span>
<a id="__codelineno-23-37" name="__codelineno-23-37" href="#__codelineno-23-37"></a>
<a id="__codelineno-23-38" name="__codelineno-23-38" href="#__codelineno-23-38"></a><span class="c1">// Calculate tau_ext</span>
<a id="__codelineno-23-39" name="__codelineno-23-39" href="#__codelineno-23-39"></a><span class="n">tau_ext</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">J</span><span class="p">.</span><span class="n">transpose</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">external_wrenches_</span><span class="p">;</span>
<a id="__codelineno-23-40" name="__codelineno-23-40" href="#__codelineno-23-40"></a>
<a id="__codelineno-23-41" name="__codelineno-23-41" href="#__codelineno-23-41"></a><span class="c1">// Calculate joint acceleration using the dynamic model: M * q_ddot = torque - C * q_dot - Fb * joint_velocities_ - g + tau_ext</span>
<a id="__codelineno-23-42" name="__codelineno-23-42" href="#__codelineno-23-42"></a><span class="n">Eigen</span><span class="o">::</span><span class="n">VectorXd</span><span class="w"> </span><span class="nf">q_ddot</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-23-43" name="__codelineno-23-43" href="#__codelineno-23-43"></a><span class="n">q_ddot</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">M</span><span class="p">.</span><span class="n">inverse</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">joint_torques_</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Fb</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">joint_velocities_</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">g_vec</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tau_ext</span><span class="p">);</span>
<a id="__codelineno-23-44" name="__codelineno-23-44" href="#__codelineno-23-44"></a>
<a id="__codelineno-23-45" name="__codelineno-23-45" href="#__codelineno-23-45"></a><span class="k">return</span><span class="w"> </span><span class="n">q_ddot</span><span class="p">;</span>
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>I suggest you use <em>VSCode</em> and install the <em>C/C++ Themes</em> extension. Once installed, you can auto format the code (usually by pressing <code>ctrl + shift + i</code>)</p>
</div>
<p>As we are implementing a discrete system:</p>
<div class="arithmatex">\[
\ddot{\mathbf{q}}_{k+1}  = \mathbf{M}^{-1}(\mathbf{q}_k) \left[  \boldsymbol{\tau}_k + \boldsymbol{\tau}_{{ext}_k} - \mathbf{C}(\mathbf{q}_k, \dot{\mathbf{q}}_k) \dot{\mathbf{q}}_k - \mathbf{F}_b \dot{\mathbf{q}}_k - \mathbf{g}(\mathbf{q}_k) \right]
\]</div>
<p>we can get the joint velocities and position by discrete integration over time as</p>
<div class="arithmatex">\[
\dot{\mathbf{q}} = \int \ddot{\mathbf{q}} \, dt \implies \dot{\mathbf{q}}_{k+1} = \dot{\mathbf{q}}_k + \ddot{\mathbf{q}}_{k+1} \cdot \Delta t
\]</div>
<div class="arithmatex">\[
\mathbf{q} = \int \dot{\mathbf{q}} \, dt \implies \mathbf{q}_{k+1} = \mathbf{q}_k + \dot{\mathbf{q}}_{k+1} \cdot \Delta t
\]</div>
<p>We can now code them as</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="c1">// Method to calculate joint velocity</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="n">Eigen</span><span class="o">::</span><span class="n">VectorXd</span><span class="w"> </span><span class="nf">calculate_velocity</span><span class="p">()</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="p">{</span>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="w">    </span><span class="c1">// Placeholder for velocity calculation</span>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="w">    </span><span class="c1">// Integrate velocity over the time step (elapsed_time_)</span>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="w">    </span><span class="n">Eigen</span><span class="o">::</span><span class="n">VectorXd</span><span class="w"> </span><span class="n">q_dot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">joint_velocities_</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">joint_accelerations_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">elapsed_time_</span><span class="p">;</span>
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a>
<a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">q_dot</span><span class="p">;</span>
<a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a><span class="p">}</span>
<a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a>
<a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a><span class="c1">// Method to calculate joint position</span>
<a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a><span class="n">Eigen</span><span class="o">::</span><span class="n">VectorXd</span><span class="w"> </span><span class="nf">calculate_position</span><span class="p">()</span>
<a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a><span class="p">{</span>
<a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a><span class="w">    </span><span class="c1">// Placeholder for position calculation</span>
<a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a><span class="w">    </span><span class="c1">// Integrate position over the time step (elapsed_time_)</span>
<a id="__codelineno-24-16" name="__codelineno-24-16" href="#__codelineno-24-16"></a><span class="w">    </span><span class="n">Eigen</span><span class="o">::</span><span class="n">VectorXd</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">joint_positions_</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">joint_velocities_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">elapsed_time_</span><span class="p">;</span>
<a id="__codelineno-24-17" name="__codelineno-24-17" href="#__codelineno-24-17"></a>
<a id="__codelineno-24-18" name="__codelineno-24-18" href="#__codelineno-24-18"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">q</span><span class="p">;</span>
<a id="__codelineno-24-19" name="__codelineno-24-19" href="#__codelineno-24-19"></a><span class="p">}</span>
</code></pre></div>
<h2 id="4-launch-the-dynamics-simulator-node">4. Launch the dynamics simulator node<a class="headerlink" href="#4-launch-the-dynamics-simulator-node" title="Permanent link">Â¶</a></h2>
<p>Once you have coded the dynamics, open a terminal and compile it:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>cdw
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>cb
</code></pre></div>
<div class="admonition success">
<p class="admonition-title">Success</p>
<p>Great! You've coded the manipulator dynamics and are now ready to launch the node to see how they work.</p>
</div>
<p>First, you'll need to launch the UMA manipulator (<a href="#21-test-the-uma-manipulator-package">step 2.1.</a>).</p>
<p>Hence, you will need to open 2 terminals and launch the following:</p>
<h4 id="terminal-1">Terminal 1<a class="headerlink" href="#terminal-1" title="Permanent link">Â¶</a></h4>
<p>Launch the UMA manipulator model <code>uma_arm_visualization.launch.py</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>ros2<span class="w"> </span>launch<span class="w"> </span>uma_arm_description<span class="w"> </span>uma_arm_visualization.launch.py
</code></pre></div>
<h4 id="terminal-2">Terminal 2<a class="headerlink" href="#terminal-2" title="Permanent link">Â¶</a></h4>
<p>Launch the dynamics model <code>uma_arm_dynamics_launch.py</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>ros2<span class="w"> </span>launch<span class="w"> </span>uma_arm_control<span class="w"> </span>uma_arm_dynamics_launch.py
</code></pre></div>
<p>Hence, you should see the following</p>
<p><img alt="launch_terminals" src="images/launch_terminals.png"></p>
<p>And the result of the simulation is</p>
<p><div class="video-container"><video style="width:100%" loop muted autoplay alt="type:video"><source src="videos/simulation_dynamics.mp4" type="video/mp4"></source></video></div></p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<ul>
<li>Note that the order when launching the scripts is important. You should first launch the <code>uma_arm_visualization</code>. By doing this, the robot model is loaded but it doesn't do anything until there's a message published in the topic <code>/joint_state</code>. </li>
<li>Then you can launch the <code>uma_arm_dynamics</code>. This is what the dynamics model does: Computes the dynamic model, and publishes the joint state to update the visualization. Note also that the dynamics node doesn't need the uma_arm_visualization to work. If you only launch the dynamics, they're computed without showing them in the uma_arm_visualization. If you run the visualization after launching the </li>
</ul>
</div>
<p>You can see the interaction between topics and nodes by openning another terminal and running</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>rqt_graph
</code></pre></div>
<p>You have to select the option <code>Node/Topics (all)</code> and then update the graph.</p>
<p><img alt="rqt_graph" src="images/rqt_graph.png"></p>
<h2 id="5-graphical-representation">5. Graphical representation<a class="headerlink" href="#5-graphical-representation" title="Permanent link">Â¶</a></h2>
<p>As robotics engineers, just seeing things work isn't enough for us. We want to understand how they work and be able to measure every parameter. One of the best ways to record the data of an experiment in ROS is to use <a href="https://docs.ros.org/en/humble/Tutorials/Beginner-CLI-Tools/Recording-And-Playing-Back-Data/Recording-And-Playing-Back-Data.html">ros bags</a>.</p>
<p>To record the data of the experiment, you can do the following:</p>
<ol>
<li>
<p>If you want to be organized, you can create an experiments folder to store the data there:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="nb">cd</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>mkdir<span class="w"> </span>experiments
</code></pre></div>
</li>
<li>
<p>Open a terminal and start the rosbag recording:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="nb">cd</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="nb">cd</span><span class="w"> </span>experiments
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a>ros2<span class="w"> </span>bag<span class="w"> </span>record<span class="w"> </span>--all<span class="w"> </span>-o<span class="w"> </span>experiment1
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a>ros2<span class="w"> </span>bag<span class="w"> </span>record<span class="w"> </span>--all
</code></pre></div>
</li>
<li>
<p>Open another terminal and launch the UMA manipulator model:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>ros2<span class="w"> </span>launch<span class="w"> </span>uma_arm_description<span class="w"> </span>uma_arm_visualization.launch.py
</code></pre></div>
</li>
<li>
<p>Open another terminal and launch the dynamics model <code>uma_arm_dynamics_launch.py</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>ros2<span class="w"> </span>launch<span class="w"> </span>uma_arm_control<span class="w"> </span>uma_arm_dynamics_launch.py
</code></pre></div>
</li>
</ol>
<p>When the experiment is finished (let's say, after around 15 seconds - when the manipulator is more or less steady) you can stop it by cancel the recording and killing the nodes. </p>
<p>To represent time series of data in ROS 2, the <a href="https://github.com/jmgandarias/uma_environment_tools">uma_environment</a> has installed the tool <a href="https://plotjuggler.io/">plotjuggler</a>. You can find more information on how to use plotjuggler in <a href="https://www.youtube.com/watch?v=9kFRecDU1bg">this video</a>.</p>
<p>You can run it by using the correspongind UMA environment alias</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a>plotjuggler
</code></pre></div>
<p>Inside plotjuggler, and following the steps in the previous video, you can play the recorded rosbag. 
If you use the layout in <a href="https://github.com/jmgandarias/advanced_robotics/blob/main/snippets/lab2/pos_vel_acc_layout.xml">pos_vel_acc_layout.xml</a>, you can plot the joint position, velocities, and accelerations.</p>
<p><img alt="experiment_results" src="images/experiment_results.png"></p>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>What are the effects of modifying the dynamics parameters of the arm?</p>
<p>You can modify some of the following parameters inside the <code>dynamics_params.yaml</code>: <code>m1</code>, <code>m2</code>, <code>b1</code>, <code>b2</code>, and <code>g</code>.
Run different experiments and plot the data to see the effects of those parameters.</p>
<p><em>Note that you only need to modify those inside <code>uma_arm_dynamics</code>.</em> </p>
</div>
<h3 id="optional-nice-plots-and-vector-images">Optional - Nice plots and vector images<a class="headerlink" href="#optional-nice-plots-and-vector-images" title="Permanent link">Â¶</a></h3>
<p>Plotjuggler is an excellent tool to visualize ROS topics data, and it also gives you some options to manipulate the data. However, sometimes you'll like to use a more powerful tool to manipulate the data such as matlab or python (with <a href="https://matplotlib.org/stable/tutorials/pyplot.html">matplotlib</a>).</p>
<p>Plotjuggler allows you to save the data in <em>csv</em> format. This way, you can easily import the data with your preferred software to plot it. Below is an expample:</p>
<ol>
<li>
<p>Click on the CSV exporter and export the data (export the data range into a file).</p>
<p><img alt="CSV_export" src="images/CSV_export.png"></p>
</li>
<li>
<p>Go to matlab, open the CSV file and select the data you want to get. In the figure below you can see how I select the time stamp (column A), and the joint position data of joint 1 (column F) and joint 2 (column H). Don't forget to exclude the rows with uninmportable cells. Then, select <em>Import selection as Generate Script</em> to generate a script that  </p>
<p><img alt="csv_matlab_import" src="images/csv_matlab_import.png"></p>
</li>
<li>
<p>You'll probably need to modify that script to change CSV location or the name of the variable that will store your data.</p>
</li>
<li>
<p>Repeat these steps as much as you need it to get the data you want to plot. Here I give you the matlab scripts to get the joint, velocity, and acceleration data, respectively. </p>
<ul>
<li><a href="https://github.com/jmgandarias/advanced_robotics/blob/main/snippets/lab2/get_position_data.m">get_position_data.m</a></li>
<li><a href="https://github.com/jmgandarias/advanced_robotics/blob/main/snippets/lab2/get_velocity_data.m">get_velocity_data.m</a></li>
<li><a href="https://github.com/jmgandarias/advanced_robotics/blob/main/snippets/lab2/get_acceleration_data.m">get_acceleration_data.m</a></li>
</ul>
</li>
<li>
<p>Once you have the data in matlab, you can manipulate it the way you want. For example, you can create nicer plots with the units and names in the axes. Here I give you the script to create a nice plot with the experiment data.</p>
<ul>
<li><a href="https://github.com/jmgandarias/advanced_robotics/blob/main/snippets/lab2/plot_resutls.m">plot_resutls.m</a></li>
</ul>
</li>
<li>
<p>You can also export the figures in a <a href="https://en.wikipedia.org/wiki/Vector_graphics">vectorial graphic</a> format such as PDF to have the best resolution possible, such as this one:</p>
<p><img alt="experiment_results" src="images/experiment_results.svg"></p>
</li>
</ol>
<p>An alternative to this is to directly use the <a href="https://es.mathworks.com/help/ros/ref/rosbag.html">ROS toolbox in Matlab</a> to get the rosbag recorded data. But I'd rather export it with PlotJuggler.</p></div>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="May 7, 2025 10:52:44"><span class="timeago" datetime="2025-05-07T10:52:44+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="May 7, 2025 10:52:44">2025-05-07</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Created">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="March 31, 2025 09:01:50"><span class="timeago" datetime="2025-03-31T09:01:50+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="March 31, 2025 09:01:50">2025-03-31</span>
  </span>

    
    
    
  </aside>


  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../lab1/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Lab 1: Cartesian trajectory planning">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Lab 1: Cartesian trajectory planning
              </div>
            </div>
          </a>
        
        
          
          <a href="../lab3/" class="md-footer__link md-footer__link--next" aria-label="Next: Lab Session 3: Inverse Dynamics Control">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Lab Session 3: Inverse Dynamics Control
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      &copy; <a href="https://jmgandarias.github.io">Juan M. Gandarias</a>, The University of MÃ¡laga, 2025 (License: <a href="https://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC</a>)<br /> <a href="#__consent">Change cookie settings</a>

    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
      <div class="md-consent" data-md-component="consent" id="__consent" hidden>
        <div class="md-consent__overlay"></div>
        <aside class="md-consent__inner">
          <form class="md-consent__form md-grid md-typeset" name="consent">
            


  


<h4>Cookie consent</h4>
<p>We use cookies to monitor the usage of these resources, and to understand how effective they are in supporting your learning. Cookies also help us to evaluate how much impact our teaching materials are making in the community. With your support, you are helping us to make our teaching resources better.</p>
<input class="md-toggle" type="checkbox" id="__settings" >
<div class="md-consent__settings">
  <ul class="task-list">
    
    
      
        
  
  
    
    
  
  <li class="task-list-item">
    <label class="task-list-control">
      <input type="checkbox" name="analytics" checked>
      <span class="task-list-indicator"></span>
      Google Analytics
    </label>
  </li>

      
    
    
      
        
  
  
    
    
  
  <li class="task-list-item">
    <label class="task-list-control">
      <input type="checkbox" name="github" checked>
      <span class="task-list-indicator"></span>
      GitHub
    </label>
  </li>

      
    
    
  </ul>
</div>
<div class="md-consent__controls">
  
    
      <button class="md-button md-button--primary">Accept</button>
    
    
    
  
    
    
    
      <label class="md-button" for="__settings">Manage settings</label>
    
  
</div>
          </form>
        </aside>
      </div>
      <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout((function(){document.querySelector("[data-md-component=consent]").hidden=!1}),250);var form=document.forms.consent;for(var action of["submit","reset"])form.addEventListener(action,(function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map((function(e){return[e,!0]})))),location.hash="",location.reload()}))</script>
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tracking", "navigation.tabs", "navigation.expand", "navigation.top", "navigation.footer", "navigation.indexes", "toc.follow", "content.code.copy", "content.code.annotate", "content.action.edit", "content.action.view"], "search": "../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.c8b220af.min.js"></script>
      
        <script src="../js/timeago.min.js"></script>
      
        <script src="../js/timeago_mkdocs_material.js"></script>
      
        <script src="../javascripts/katex.js"></script>
      
        <script src="../assets/external/unpkg.com/katex@0/dist/katex.min.js"></script>
      
        <script src="../assets/external/unpkg.com/katex@0/dist/contrib/auto-render.min.js"></script>
      
    
  </body>
</html>